# AI LineBot 客服系統規劃文件 (POC 階段)

## 專案願景

AI LineBot 客服系統旨在為台灣中小品牌提供一個智能化的 LINE 客服解決方案，幫助他們提高客服效率、降低人力成本，同時提升客戶滿意度。系統可以自動回答常見問題、在必要時智能轉接人工客服，並提供對話摘要分析。

## POC 階段目標

1. **技術驗證**：驗證 AI 客服在 LINE Bot 上的可行性和效能
2. **核心功能**：實現基本的自動問答和人工轉接功能
3. **效果評估**：評估自動回覆的準確度和用戶滿意度

## 系統架構 (POC)

### 簡化架構

```
AI LineBot 客服 POC
├── LINE Bot 服務 (接收和發送訊息)
├── AI 客服邏輯 (處理用戶訊息)
└── 簡易儲存 (保存對話記錄)
```

### 技術架構

```
app/
├── api/            # webhook 端點
│   └── v1/         # API v1 版本
├── services/       # 業務邏輯服務
├── agents/         # AI 客服代理
├── models/         # 簡易資料模型
└── utils/          # 通用工具
```

## 技術選擇 (POC)

### 核心技術

- **框架**：FastAPI - 高性能非同步框架
- **LINE SDK**：line-bot-sdk-python - 官方支持的 SDK
- **儲存**：SQLite 或檔案儲存 - POC 階段簡易儲存
- **AI 模型**：OpenAI GPT-4o-mini - 性價比高的 AI 模型
- **向量化**：考慮 OpenAI Embeddings API - 簡單易用

## POC 資料設計

### 核心資料

1. **知識庫**
   - 可以是文字檔案或 JSON 格式
   - 儲存常見問題與答案
   - 支援透過向量搜尋相關內容

2. **對話紀錄**
   - 對話 ID、用戶 ID、時間戳記等基本資訊
   - 用戶與機器人的訊息內容
   - 可以簡單使用檔案系統或 SQLite 儲存

## API 設計 (POC)

### 簡化 API 端點

1. **LINE Bot Webhook**
   - `POST /api/v1/webhook` - 接收 LINE 的訊息，這是唯一對外的端點

2. **測試端點** (開發使用)
   - `POST /api/v1/test/message` - 模擬發送訊息以測試回應
   - `GET /api/v1/health` - 健康檢查

## 核心功能 (POC)

1. **AI 客服回答**
   - 使用 AI 模型處理用戶問題
   - 必要時透過 RAG 技術查詢知識庫
   - 簡易對話狀態管理

2. **人工轉接功能**
   - 特定關鍵字觸發 (`@人工`, `@客服`)
   - 通知機制 (可以是 LINE Notify 或電子郵件)

3. **對話紀錄**
   - 記錄對話內容以便後續分析
   - 只需本地儲存，不需要複雜的查詢功能

## 代碼組織

### 程式碼結構優化

1. **核心元件**
   - `line_webhook.py`: 處理 webhook 請求
   - `line_service.py`: LINE 訊息收發邏輯
   - `conversation_handler.py`: 對話處理邏輯
   - `agent.py`: AI 客服代理

2. **工具類**
   - `rag_utils.py`: RAG 相關工具函數
   - `line_utils.py`: LINE API 相關工具
   - `storage.py`: 簡易儲存工具

### 工作流程

```
用戶發送訊息 -> LINE Webhook -> conversation_handler 處理 -> 
agent 生成回應 (必要時使用 RAG) -> line_service 發送回應
```

## 命名慣例

- **文件命名**：小寫單字加底線，如 `line_utils.py`
- **類命名**：駝峰式大寫，如 `ConversationHandler`
- **函數和變數**：小寫單字加底線，如 `process_message()`
- **常數**：全大寫加底線，如 `DEFAULT_TIMEOUT`

## 安全考量 (POC)

1. **LINE 平台安全**
   - Channel Secret 安全存儲
   - Webhook 簽名驗證

2. **基本資料安全**
   - 環境變數管理敏感資訊
   - 適當的錯誤處理與日誌記錄

## 部署策略 (POC)

- **本地開發環境**
- **簡易測試部署**：使用 ngrok 或其他工具進行本地測試
- **可選雲端**：Railway 或 Vercel 等簡易部署平台

## 代碼清理目標

### 當前存在問題

1. **過長檔案**
   - linebot.py (171行) 和 linebot_service.py (171行) 過長
   - 需要分解為更小、更專注的模組

2. **混亂的責任劃分**
   - API、服務邏輯和回覆生成混在一起
   - 需要更清晰的分層和責任劃分

3. **缺少資料模型**
   - models 目錄為空
   - 需要根據需求建立最小必要的資料模型

4. **未實現的核心功能**
   - RAG 功能未完全實現
   - 人工轉接功能需要完善

### 改進策略

1. **重構 Webhook 處理**
   - 保持 webhook 端點簡單
   - 將業務邏輯移至服務層
   - 使用依賴注入建立更易測試的結構

2. **優化代碼模組化**
   - 按照功能將代碼分割成更小的文件
   - 維持每個文件在 100 行以內
   - 增強代碼復用性

3. **優化錯誤處理**
   - 實現統一的錯誤處理機制
   - 增加詳細的日誌記錄

4. **補充測試**
   - 針對核心邏輯編寫單元測試
   - 實現一個簡單的測試框架

5. **環境配置優化**
   - 建立 .env.example 作為範例
   - 優化配置管理

## 具體重構任務

1. [ ] 重構 api/v1/linebot.py，拆分為更小的模組
2. [ ] 重構 services/linebot_service.py，分離核心功能
3. [ ] 完善 models 目錄，增加必要的資料模型
4. [ ] 建立 RAG 相關的工具函數
5. [ ] 優化錯誤處理和日誌記錄
6. [ ] 建立基本測試框架和單元測試
7. [ ] 建立環境變數範例和文檔 